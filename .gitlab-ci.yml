stages:
  - regen-lock

regen-lock-pr:
  stage: regen-lock
  image: node:18
  script:
    - npm install --package-lock-only
    - short_sha=$(echo $CI_COMMIT_SHA | cut -c1-7)
    - timestamp=$(date +%Y-%m-%d-%H-%M-%S)
    - branch_name="regen-lock-$short_sha-$timestamp"
    - git checkout -b $branch_name
    - git add package-lock.json
    - git commit -m "chore: regenerate package-lock.json"
    - git push origin $branch_name
    - |
      curl -X POST \
        -H 'Authorization: token $GITHUB_TOKEN' \
        -H 'Accept: application/vnd.github.v3+json' \
        https://api.github.com/repos/ambarish135/loan-calculator/pulls \
        -d '{"title":"chore: regenerate package-lock.json (CI)", "body":"This PR regenerates package-lock.json as part of CI job.", "head":"'$branch_name'", "base":"main"}'
  only:
    - main